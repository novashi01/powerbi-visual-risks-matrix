# v1.3.0 Inherent Risk Display - CORRECTED

## ✅ Issue Fixed

**Problem:** Inherent markers were positioned as offset from residual marker in the SAME cell.

**Correct Behavior:** Inherent markers should be in their ORIGINAL cell (inherent L×C), and arrows should go from inherent cell to residual cell.

## How It Works Now

### Example: Risk moves from (2,2) to (4,4)

**Before (WRONG):**
```
Cell (4,4) - Residual Position:
┌────────────────┐
│  ○→●           │  ← Both in same cell
│  Risk-123      │     with small offset
└────────────────┘
```

**After (CORRECT):**
```
Cell (2,2) - Inherent:    Cell (4,4) - Residual:
┌────────────────┐        ┌────────────────┐
│     ○          │────→   │      ●         │
│  Risk-123      │  Arrow │   Risk-123     │
└────────────────┘        └────────────────┘

Arrow goes across matrix cells!
```

## Visual Example

### 3×3 Matrix with Risk Movement

```
     Low L       Med L       High L
   ┌─────────┬─────────┬─────────┐
H  │         │         │    ●    │  High
i  │         │         │  R-098  │  Consequence
g  │         │         │         │
h  ├─────────┼─────────┼─────────┤
   │         │    ●    │         │  Medium
M  │         │  R-067  │         │  Consequence
e  │         │         │         │
d  ├─────────┼─────────┼─────────┤
   │   ○     │         │         │  Low
L  │ R-098   │         │         │  Consequence
o  │         │         │         │
w  └─────────┴─────────┴─────────┘

Risk-098 Journey:
• Started at (Low L, Low C) = ○ Inherent marker
• Moved to (High L, High C) = ● Residual marker
• Arrow shows the risk treatment path

Risk-067 Journey:
• No movement (inherent = residual)
• Only shows ● residual marker
```

## Code Changes Made

### renderOrganizedLayout() - Rewritten

**Now does:**
1. Groups risks by RESIDUAL cell position
2. Groups risks by INHERENT cell position (if different)
3. Organizes markers in each cell independently
4. Renders residual markers in their cells
5. Renders inherent markers in their cells
6. Draws arrows from inherent position to residual position

**Key Logic:**
```typescript
// Group by residual cell
residualCellMarkers[`${lRes}-${cRes}`].push(risk);

// Group by inherent cell (if different)
if (lInh !== lRes || cInh !== cRes) {
    inherentCellMarkers[`${lInh}-${cInh}`].push(risk);
}

// Organize in each cell separately
organizeMarkersInCell(residualCellMarkers[cellKey], ...);
organizeMarkersInCell(inherentCellMarkers[cellKey], ...);

// Draw arrows between cells
arrow from organizedPositions[id].inherent
      to organizedPositions[id].residual
```

### renderSingleMarker() - New Method

Replaces `renderOrganizedMarker()` with simpler logic:
- Renders ONE marker (either inherent or residual)
- Type determines appearance:
  - Inherent: ○ semi-transparent, smaller
  - Residual: ● full color, full size
- No arrow logic (handled separately)

## Arrow Behavior

### Case 1: Risk Moved (Inherent ≠ Residual)
```
Inherent Cell (2,3):          Residual Cell (4,5):
      ○                 →→→         ●
  Semi-transparent            Full color
  Smaller (r-1)              Full size (r)
```

### Case 2: Risk Unchanged (Inherent = Residual)
```
Same Cell (3,3):
      ●
  Only residual marker
  No inherent marker
  No arrow
```

### Case 3: Multiple Risks in Same Cells
```
Inherent Cell (2,2):          Residual Cell (4,4):
┌──────────────┐              ┌──────────────┐
│ ○   ○   ○    │  ──→         │ ●   ●   ●    │
│ ○   ○   ○    │  ──→         │ ●   ●   ●    │
│ ○   ○   ○    │  ──→         │ ●   ●   ●    │
└──────────────┘              └──────────────┘
Each risk organized in its own grid position
Arrows connect corresponding positions
```

## Settings Behavior

### Show Inherent Risks = ON
- Inherent markers (○) visible in their original cells
- Residual markers (●) visible in their current cells
- Arrows connect them (if Show Arrows = ON)

### Show Inherent Risks = OFF
- Only residual markers (●) visible
- No inherent markers
- No arrows (nothing to connect)

### Show Arrows = OFF (with Show Inherent = ON)
- Both ○ and ● markers visible
- No connecting arrows
- Good for dense matrices

## Testing Scenarios

### Scenario 1: Single Risk Movement
- Inherent: (2,2)
- Residual: (4,4)
- **Expect:** ○ in cell (2,2), ● in cell (4,4), arrow between them

### Scenario 2: Multiple Risks Same Path
- Risk-A: I(2,2) → R(4,4)
- Risk-B: I(2,2) → R(4,4)
- Risk-C: I(2,2) → R(4,4)
- **Expect:** 3 ○ markers organized in cell (2,2), 3 ● markers organized in cell (4,4), 3 arrows

### Scenario 3: Risks Diverging
- Risk-A: I(2,2) → R(4,4)
- Risk-B: I(2,2) → R(3,5)
- Risk-C: I(2,2) → R(5,3)
- **Expect:** 3 ○ markers in cell (2,2), ● markers spread across different cells, arrows diverge

### Scenario 4: Risks Converging
- Risk-A: I(1,1) → R(3,3)
- Risk-B: I(2,2) → R(3,3)
- Risk-C: I(4,4) → R(3,3)
- **Expect:** ○ markers in 3 different cells, 3 ● markers organized in cell (3,3), arrows converge

### Scenario 5: No Movement
- Risk-A: I(3,3) → R(3,3)
- **Expect:** Only ● marker in cell (3,3), no ○, no arrow

## Benefits of This Approach

✅ **Visually Accurate:** Shows actual risk movement across matrix
✅ **Clear Journey:** Easy to see where risks started and where they are now
✅ **Organized:** Both inherent and residual markers use grid positioning
✅ **Scalable:** Works with any number of risks
✅ **Flexible:** Arrows can be toggled independently

## Performance Notes

- Slightly more processing (organizing two sets of cells)
- More arrows to render (longer lines across matrix)
- Still performant for 100+ risks
- Acceptable for typical use cases

---

**Status:** ✅ Fixed and ready for testing!

Run `VERIFY-V1.3.0.bat` to test the corrected behavior.