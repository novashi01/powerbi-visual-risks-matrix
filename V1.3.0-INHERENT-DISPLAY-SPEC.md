# v1.3.0 Complete Feature Specification

## Inherent Risk Display in Organized Grid Mode

### âœ… **Requirement Confirmed**

When **Positioning Mode = "Organized Grid"**, the visual should display:

1. **Inherent Risk Marker** (â—‹)
   - Lighter colored or semi-transparent circle
   - Shows where the risk started (before treatment)
   - Positioned within the organized grid of the cell

2. **Residual Risk Marker** (â—)
   - Full colored circle
   - Shows where the risk is now (after treatment)
   - Positioned within the organized grid of the cell

3. **Arrow** (â—‹â†’â—)
   - Connects inherent to residual marker
   - Shows the "risk journey" or improvement
   - Animatable (if animation enabled)
   - Can be toggled on/off with "Organized Arrows" setting

### ğŸ“ Visual Example

```
Single Cell in Organized Grid Mode (3Ã—3 markers):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Risk-001    Risk-002    Risk-003   â”‚
â”‚   â—‹â†’â—          â—          â—‹â†’â—       â”‚  â† Row 1
â”‚                                     â”‚
â”‚  Risk-004    Risk-005    Risk-006   â”‚
â”‚     â—        â—‹â†’â—           â—        â”‚  â† Row 2
â”‚                                     â”‚
â”‚  Risk-007    Risk-008    Risk-009   â”‚
â”‚   â—‹â†’â—          â—          â—‹â†’â—       â”‚  â† Row 3
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
â—‹ = Inherent risk position (semi-transparent)
â— = Residual risk position (full color)
â†’ = Arrow showing risk treatment effect
Solid â— only = No change from inherent to residual
```

### ğŸ¨ Visual States

#### State 1: Risk Improved (Inherent > Residual)
```
High â†’ Low Risk:
  â—‹â”€â”€â”€â”€â”€â”€â”€â†’â—
  ^         ^
  |         |
Inherent  Residual
(5Ã—5)     (2Ã—2)
```

#### State 2: Risk Unchanged (Inherent = Residual)
```
Same Risk Level:
     â—
     ^
     |
Both Inherent & Residual
(3Ã—3)
```

#### State 3: Risk Worsened (Inherent < Residual)
```
Low â†’ High Risk:
  â—‹â”€â”€â”€â”€â”€â”€â”€â†’â—
  ^         ^
  |         |
Inherent  Residual
(2Ã—2)     (4Ã—5)
```

### âš™ï¸ Settings Control

**Risk Markers Layout Panel:**

1. **Positioning Mode** = "Organized Grid"
   - Required for this feature to work
   
2. **Show Inherent in Organized** (Toggle)
   - ON: Display both â—‹ and â— markers
   - OFF: Display only â— residual markers
   - Default: ON

3. **Organized Arrows** (Toggle)
   - ON: Show â—‹â†’â— arrows when inherent â‰  residual
   - OFF: Show markers only, no arrows
   - Default: ON
   - Only relevant when "Show Inherent" is ON

4. **Marker Rows** Ã— **Marker Columns**
   - Controls grid size within each cell
   - Example: 3Ã—3 = 9 possible marker positions per cell

### ğŸ”§ Implementation Requirements

#### 1. renderOrganizedLayout Method

```typescript
private renderOrganizedLayout(
    data: RiskPoint[], 
    toXY: (l, c) => {x, y},
    cellPadding: number,
    cw: number, ch: number,
    sm: ISelectionManager,
    markerRows: number,
    markerCols: number,
    showInherent: boolean,      // NEW: Show inherent markers
    showArrows: boolean          // NEW: Show arrows in organized mode
) {
    // Group risks by their RESIDUAL position (lRes, cRes)
    const cellMarkers = this.groupByCell(data);
    
    // For each cell that has risks
    Object.keys(cellMarkers).forEach(cellKey => {
        const risks = cellMarkers[cellKey];
        const cellBounds = this.getCellBounds(cellKey, cw, ch);
        
        // Organize markers in nÃ—n grid within the cell
        const organized = this.organizeMarkersInCell(
            risks, 
            cellBounds, 
            cellPadding,
            markerRows,
            markerCols
        );
        
        // Render each marker with its organized position
        organized.forEach((marker, index) => {
            this.renderOrganizedMarker(
                marker,
                sm,
                showInherent,
                showArrows
            );
        });
    });
}
```

#### 2. renderOrganizedMarker Method

```typescript
private renderOrganizedMarker(
    marker: OrganizedMarker,
    sm: ISelectionManager,
    showInherent: boolean,
    showArrows: boolean
) {
    const d = marker.data;
    const organizedPos = marker.position; // {x, y} within cell
    
    // Calculate inherent position (if exists and different)
    const hasInherent = d.lInh && d.cInh && 
                       (d.lInh !== d.lRes || d.cInh !== d.cRes);
    
    // 1. Render inherent marker (if enabled and exists)
    if (showInherent && hasInherent) {
        // Position slightly offset from organized position
        const inherentPos = {
            x: organizedPos.x - 6,  // Offset left
            y: organizedPos.y - 6   // Offset up
        };
        
        this.renderMarkerCircle(
            inherentPos,
            d,
            "inherent",  // Type: semi-transparent
            sm
        );
    }
    
    // 2. Render arrow (if enabled, inherent shown, and positions differ)
    if (showArrows && showInherent && hasInherent) {
        const inherentPos = {
            x: organizedPos.x - 6,
            y: organizedPos.y - 6
        };
        
        this.renderArrow(
            inherentPos,
            organizedPos,
            this.formattingSettings.arrowsCard.arrowDistance.value
        );
    }
    
    // 3. Render residual marker (always shown)
    this.renderMarkerCircle(
        organizedPos,
        d,
        "residual",  // Type: full color
        sm
    );
    
    // 4. Render label (if enabled)
    if (this.formattingSettings.labelsCard.show.value) {
        this.renderLabel(organizedPos, d.id);
    }
}
```

#### 3. organizeMarkersInCell Method

```typescript
private organizeMarkersInCell(
    markers: any[],
    cellBounds: {x, y, width, height},
    padding: number,
    rows: number,
    cols: number
): OrganizedMarker[] {
    // Calculate sub-grid positions within cell
    const usableWidth = cellBounds.width - (padding * 2);
    const usableHeight = cellBounds.height - (padding * 2);
    
    const markerSpacingX = usableWidth / cols;
    const markerSpacingY = usableHeight / rows;
    
    const organized: OrganizedMarker[] = [];
    const maxMarkers = rows * cols;
    
    // Limit to grid capacity
    const markersToShow = markers.slice(0, maxMarkers);
    
    markersToShow.forEach((marker, index) => {
        const row = Math.floor(index / cols);
        const col = index % cols;
        
        const x = cellBounds.x + padding + (col * markerSpacingX) + (markerSpacingX / 2);
        const y = cellBounds.y + padding + (row * markerSpacingY) + (markerSpacingY / 2);
        
        organized.push({
            data: marker.data,
            position: { x, y },
            color: marker.color
        });
    });
    
    return organized;
}
```

### ğŸ¬ Animation Support

When **Animation** is enabled:

1. **Initial Render**: Show residual markers only
2. **Animate In**: 
   - Inherent markers fade in
   - Arrows draw from inherent to residual
   - Duration: configurable (default 1000ms)
3. **Continuous**: Arrows can pulse or remain static

```typescript
if (animationEnabled) {
    // Animate marker appearance
    marker.style.opacity = "0";
    marker.style.transition = `opacity ${duration}ms ease-in`;
    
    requestAnimationFrame(() => {
        marker.style.opacity = "1";
    });
    
    // Animate arrow drawing
    if (showArrows) {
        arrow.style.strokeDasharray = length;
        arrow.style.strokeDashoffset = length;
        arrow.style.transition = `stroke-dashoffset ${duration}ms ease-in`;
        
        requestAnimationFrame(() => {
            arrow.style.strokeDashoffset = "0";
        });
    }
}
```

### ğŸ“Š Example Scenarios

#### Scenario 1: Risk Treatment Portfolio
**Matrix**: 5Ã—5  
**Markers per cell**: 3Ã—3 (9 risks)  
**Show Inherent**: YES  
**Organized Arrows**: YES

**Result**: Shows risk improvement across portfolio with visual arrows indicating treatment effectiveness

#### Scenario 2: Current State Only
**Matrix**: 4Ã—4  
**Markers per cell**: 4Ã—4 (16 risks)  
**Show Inherent**: NO  
**Organized Arrows**: N/A

**Result**: Clean view of current (residual) risk state without historical context

#### Scenario 3: Dense Portfolio Review
**Matrix**: 7Ã—7  
**Markers per cell**: 2Ã—2 (4 risks)  
**Show Inherent**: YES  
**Organized Arrows**: NO

**Result**: Shows both inherent and residual markers positioned together without connecting arrows (cleaner for dense cells)

### âœ… Implementation Checklist

- [ ] Add `showInherentInOrganized` to settings.ts
- [ ] Add `organizedArrows` to settings.ts
- [ ] Add both settings to capabilities.json
- [ ] Implement `renderOrganizedLayout` with showInherent/showArrows parameters
- [ ] Implement `renderOrganizedMarker` to handle both marker types
- [ ] Implement inherent marker offset positioning
- [ ] Implement arrow rendering between inherentâ†’residual
- [ ] Add animation support for marker appearance
- [ ] Add animation support for arrow drawing
- [ ] Test with various grid configurations
- [ ] Test with risks that have no inherent data
- [ ] Test with risks where inherent = residual
- [ ] Document in release notes

### ğŸ¯ Success Criteria

1. âœ… User can toggle "Show Inherent in Organized" on/off
2. âœ… User can toggle "Organized Arrows" on/off
3. âœ… Inherent markers render in organized grid positions
4. âœ… Residual markers render in organized grid positions
5. âœ… Arrows connect inherent to residual when appropriate
6. âœ… Animation works smoothly
7. âœ… Performance is acceptable with 100+ risks
8. âœ… Works across different matrix sizes (3Ã—3 to 10Ã—10)
9. âœ… Works with different marker grid sizes (2Ã—2 to 5Ã—5)
10. âœ… Backward compatible with existing reports

---

**Priority**: HIGH  
**Complexity**: MEDIUM  
**Estimated Time**: 3-4 hours  
**Dependencies**: Settings UI completion, Organized layout foundation